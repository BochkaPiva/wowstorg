# Напоминания о возврате реквизита (cron 10:45 МСК)

Ежедневно в **10:45 по Москве** вызывается задача: владельцам заявок в статусе «Выдана» (ISSUED) отправляются уведомления в Telegram:

- **Последний день аренды** (endDate = сегодня) — напоминание, что сегодня последний день.
- **Просрочка** (endDate уже прошёл) — уведомление о просрочке сдачи на приемку.

Эндпоинт: `GET /api/cron/return-reminders`. Защищён секретом: без правильного `CRON_SECRET` возвращается 401.

---

## 1. Сгенерировать и сохранить секрет

Секрет должен быть длинной случайной строкой (например, 32+ символов). Храните его только в переменных окружения (Vercel / .env.local), **не коммитьте в репозиторий**.

Пример генерации (локально в терминале):

```bash
node -e "console.log(require('crypto').randomBytes(32).toString('base64url'))"
```

Скопируйте вывод — это ваш `CRON_SECRET`.

---

## 2. Вариант A: Vercel Cron (рекомендуется)

Проект уже настроен: в `vercel.json` указано расписание `45 7 * * *` (07:45 UTC = 10:45 МСК).

### Шаги

1. Откройте проект в [Vercel Dashboard](https://vercel.com/dashboard) → выберите проект → **Settings** → **Environment Variables**.

2. Добавьте переменную:
   - **Name:** `CRON_SECRET`
   - **Value:** ваш сгенерированный секрет (из шага 1)
   - **Environment:** Production (и при необходимости Preview).

3. Сохраните и сделайте **Redeploy**, чтобы переменная подхватилась.

4. Проверка работы cron:
   - В Vercel: **Settings** → **Crons** — там должен быть один cron с путём `/api/cron/return-reminders` и расписанием `45 7 * * *`.
   - Vercel при вызове cron **не подставляет** секрет автоматически. Нужно либо использовать **Вариант B** (внешний сервис с GET и `?secret=...`), либо проверить, есть ли в настройках Cron опция «Secret» (если есть — укажите тот же `CRON_SECRET`).

Если в интерфейсе Vercel для Cron нет поля «Secret», то запрос к эндпоинту идёт без заголовка/параметра, и наш код вернёт 401. В этом случае используйте **Вариант B** (внешний cron с секретом в URL).

---

## 3. Вариант B: Внешний cron (cron-job.org и др.)

Подходит, если Vercel не передаёт секрет при вызове cron или вы хотите вызывать задачу с другого сервера.

### Шаги

1. Зарегистрируйтесь на [cron-job.org](https://cron-job.org) (или аналог: EasyCron, Uptime Robot с расписанием и т.п.).

2. Создайте задачу:
   - **URL:**  
     `https://ВАШ-ДОМЕН.vercel.app/api/cron/return-reminders?secret=ВАШ_CRON_SECRET`
   - Подставьте реальный домен и тот же секрет, что добавлен в Vercel в `CRON_SECRET`.
   - **Метод:** GET.
   - **Расписание:** каждый день в 10:45. В cron-job.org обычно можно выбрать «Daily» и время 10:45; укажите часовой пояс **Europe/Moscow** (или UTC+3), чтобы 10:45 было по Москве.

3. В Vercel в **Environment Variables** переменная `CRON_SECRET` должна быть установлена в то же значение, что в URL (иначе эндпоинт вернёт 401).

4. Сохраните задачу. Сервис будет вызывать URL по расписанию.

---

## 4. Ручная проверка

После деплоя можно вызвать эндпоинт вручную.

**С секретом в заголовке (если используете Bearer):**

```bash
curl -H "Authorization: Bearer ВАШ_CRON_SECRET" "https://ВАШ-ДОМЕН.vercel.app/api/cron/return-reminders"
```

**С секретом в URL (удобно для внешнего cron):**

```bash
curl "https://ВАШ-ДОМЕН.vercel.app/api/cron/return-reminders?secret=ВАШ_CRON_SECRET"
```

Успешный ответ (200):

```json
{
  "ok": true,
  "today": "2025-02-26",
  "lastDayReminders": 1,
  "overdueReminders": 0
}
```

- `lastDayReminders` — сколько напоминаний «последний день» отправлено.
- `overdueReminders` — сколько уведомлений о просрочке отправлено.

При отсутствии или неверном секрете — 401 Unauthorized. Если переменная `CRON_SECRET` не задана в окружении — 503.
